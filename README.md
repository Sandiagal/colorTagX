# colorTagX
一款色标插件，通过编辑色标，实现了给数字矩阵上色的功能。

## 封面
![](https://github.com/Sandigle/colorTagX/raw/master/image/1.jpg) 

## 简介
colorTagX是一款色标插件。该项目来源于某个软件技能竞赛。按照课题组的要求，本软件实现了以下功能：
- 色标分内置色标和自定义色标两类，内置色标样式丰富。
- 内置色标具自适应功能，可根据数据情况自动调整高低门槛。
- 自定义色标初始为空目录，用户可对内置色标进行编辑，编辑后保存为自定义色标，内置色标保持不变。
- 编辑功能支持锁定门槛值、修改关键点颜色、在任意位置插入新的关键点、设置色标总分段数、色标反转、透明度修改等。

该软件基于C++编程语言和QT图形界面设计，采用面向对象程序设计，可以在Windows7/8/10平台上顺利运行。

## 关键技术以及创新点
- 1、色标分内置和自定义两类，样式丰富

色标的贮存和修改使用了自创的xgradient类。该类使用了QT的QLinearGradient类来记录色标条，并用QT的QGradientStops类来记录关键点。获得关键点之后，通过差值运算即可得到其余点的颜色。软件内置了11种专业色标，分别为Autumn、Bone、Cool、Copper、Gray、Hot、Hsv、Jet、Pink、Spring以及Summer。
- 2、可对内置色标编辑，保存为自定义色标

软件使用了QVector将色标名称QString类和色标信息xgradient类组成向量矩阵。初始11个位置为内置色标，后续位置为自定义色标。程序在进行编辑内置色标时无法进行保存和删除操作，只能进行新建和取消操作，即保持内置色标不变。而对自定义色标进行编辑时则解锁所有操作。
- 3、内置色标具自适应功能，可自动调整高低门槛

色标的自适应功能由系统内的置信系数决定。colorTag类中的pauta函数将基于统计学上的拉依达法则对输入数据进行统计分析，根据置信系数，计算出数据的置信最大最小值。每次调整置信系数都会刷新图像，依次实现自动调整门槛高低的功能。
- 4、编辑功能支持多项变化等

色标的门槛可以在主界面的“置信最小值”或者“置信最大值”下方直接输入需要的阈值，以此实现锁定门槛值的功能。对色标关键点的操作全部通过BarAdvance类对xgradient类中的QGradientStops类进行修改，以调整关键点的位置和颜色。

BarAdvance类是一个矩形的色标显示框。鼠标在框上滑动时，该类会记录鼠标位置。当鼠标按下时，根据已经贮存的色标位置信息，该类会决定鼠标是否选中已有关键点。如果选中了已有关键点，则可以通过鼠标进行调整。按住Shift时可以上下移动调整该点的透明度；没有按住Shift时可以左右移动调整关键点的位置；右键可以删除关键点。如果鼠标按下时没有选中已有关键点，则插入关键点。单击鼠标则在该位置创建一个属性等同于该位置像素的关键点。双击鼠标则会调用QColorDialog类来创建可以自定义颜色的关键点。

对关键点的位置信息进行相减运算，即可实现色标反转的功能。xgradient类存贮的是连续的色标信息，对色标的分段工作由colorTag类的getColor函数实现。getColor函数创建了一个长度等于色阶数的Qcolor类向量，通过提取xgradient类中指定位置的颜色信息，实现色标信息的离散化，从而达到色标分段效果。
- 5、实时响应的处理速度，优化的数据存贮结构

图像的数据结构为整形数组组成的字符串TXT文档。使用了atof函数进行数据的结构转换，读取2300 2300大小的文档只需要2600ms。渲染图像时，预先计算完了色标的离散数据。在对像素进行赋值时，没有再对色标进行采样，而是直接调用离散数据，提高了处理速度。处理2300 2300大小的图片只需要210ms。

软件使用了可以自动开辟内存的二维向量类来贮存输入数据的整形数值。AmazeBuffer类中存贮了现有的数据大小，会根据读取的数据坐标使用alloc函数开启内存空间。该方法比起直接定义超大的二维数据要节约大量空间。

色标使用了TXT文档进行存取，位于软件根目录中的save.txt里。存储了色标的差值方式、名称、关键点坐标和颜色的RGB值。非常方便识别和修改。
- 6、多样的数据展示方式

软件中拥有众多的数据展示方式，并且所有信息都会根据操作实时更新。色标编辑界面中展示了色标编辑条。鼠标划过时，会显示当前位置的颜色信息。进行关键点操作时会更新关键点总数信息。对色标的调整结果会实时地显示在色标编辑条上。

主界面中展示了色标选择框、输入数据的最大值、最小值、置信最大值、置信最小值、输出图像预览、当前色标预览以及鼠标指针处的颜色、坐标、元数据信息。色标选择框中包含了所有色标的名称以及图形预览。当前色标预览更加表现出了色标的色阶效果。输出图像预览展示了图像的最终展示效果，并且可以通过鼠标滚轮进行缩放，而双击滚轮则会使缩放重置。鼠标在当前色标预览和输出图像预览上划过时，鼠标指针处的颜色和坐标都会在下方显示。
## 使用说明及测试效果
- 1、进入软件
![](https://github.com/Sandigle/colorTagX/raw/master/image/2.jpg) 

打开根目录下的colorTagX.exe，即可进入软件主界面。

软件会自动读取根目录下的色标贮存文件save.txt。 
 
- 2、输入数据

点击上方的“选择路径”按钮，可以输入数据。

软件内置了4个数据包，分别是100.txt，1000.txt，1000_2.txt，2300.txt。每个数据包为正方形整形矩阵，名称代表矩阵的边长。其中1000_2.txt存放的是带有极端值的数据。
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/3.jpg) 
 
这里选取1000.txt作为示范。
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/4.jpg) 
 
可以看到，数据矩阵已经被上色，转换为RGB图像。左侧显示出了当前使用的色标、数据最大值、数据最大值、置信数据最大值、置信数据最大值。图像预览区下方显示出了鼠标出的颜色和坐标。

此时可以在数据区下方通过滑动条调整数据置信水平和色阶数，也可以直接对置信数据值进行赋值。所有调整都能实时更新。调整结果预览图如下：
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/5.jpg) 
 
此时也可以通过当前色标预览框下的色标选项卡进行切换色标：
  ![](https://github.com/Sandigle/colorTagX/raw/master/image/6.jpg) 
  
- 3、色标自适应功能的测试

选取1000_2.txt文件进行测试。该文件的下部区域的数值被人为的翻倍。
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/7.jpg) 
 
可以看到数据最大值提高到了508，而软件自动将有效数据范围限制在了-23至298之前。同时，图像预览区中下方的极端数值区全部被红色覆盖，证明了该区域已经被限制。

- 4、编辑色标

点击当前色标预览框右方的“编辑样式”按钮，可以进入色标编辑窗口。
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/8.jpg) 
 
在该窗口下，鼠标滑过色标条，下方能实时显示指针处的数据。差值空间选项卡可以切换差值方式。“色标反转”可以反转色标。同时由于该色标时内置色标，所以显示了“禁止修改”，并且“修改”和“删除”按钮被禁止。

用户可以通过鼠标直接对关键点进行修改。当鼠标按下时，如果选中了已有关键点，则可以通过鼠标进行调整。按住Shift时可以上下移动调整该点的透明度；没有按住Shift时可以左右移动调整关键点的位置；右键可以删除关键点。如果鼠标按下时没有选中已有关键点，则插入关键点。单击鼠标则在该位置创建一个属性等同于该位置像素的关键点。双击鼠标则可以创建可以自定义颜色的关键点。

色标修改测试如下：
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/9.jpg) 
 ![](https://github.com/Sandigle/colorTagX/raw/master/image/10.jpg) 
 
这里切换了差值方式，又进行了色标反转，同时修改了已有关键点的位置和透明度，并且新增减了部分关键点。由于Jet是内置色标，所以这里只能进行“添加”操作。为了避免重名，软件会自动将色标重命名为Jet_copy。
- 5、输出图像

点击左下侧的“选择路径”按钮，可以指定文件的输出路径。

点击下方的“输出”按钮可以将上色结果以png格式输出。
![](https://github.com/Sandigle/colorTagX/raw/master/image/11.jpg) 
 
输出结果图如下：
  ![](https://github.com/Sandigle/colorTagX/raw/master/image/12.jpg) 
